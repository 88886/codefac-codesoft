<?xml version="1.0" encoding="UTF-8"?>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE html>
<ui:composition xmlns="http://www.w3.org/1999/xhtml" 
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core" 
                xmlns:ui="http://java.sun.com/jsf/facelets" 
                xmlns:p="http://primefaces.org/ui"
                xmlns:b="http://bootsfaces.net/ui"
                template="/template/plantilladmin.xhtml">


    <ui:define name="contenido" >

        <div style="text-align:center">
            <p:panel header="Nueva Compra"  style="width: 60%;margin: 0 auto" styleClass="titleBarAzul" > 
                <!-- Formulario para controlar el encabezado de la compra -->
                <h:form id="formDetalleDistribuidor">

                    <!-- Ecabezado para buscar el ruc del distribuidos-->
                    <p:panel header="Datos De la Compra" styleClass="panelNoBorder titleBarVerde">
                        <div style="text-align: center">
                            <p:panelGrid columns="3" style="margin: 0 auto" >

                                <p:inputText
                                    size="20"
                                    id="txtRuc" 
                                    placeholder="RUC del distribuidor"
                                    onkeypress="return validarEnter(event, 'buscarDistribuidorJS');"  
                                    value="#{comprarMB.compra.ruc.ruc}" 

                                    />

                                <p:remoteCommand name="buscarDistribuidorJS" actionListener="#{comprarMB.consultarDistribuidor()}" update="gridDatosCompra" />

                                <p:commandButton 
                                    id="btnEncontrarDitribuidor"                                    
                                    icon="ui-icon-search" 
                                    styleClass="ui-botonEsmeralda" />

                                <p:tooltip style="font-size: 11px" id="toolTipGrow" for=":formDetalleDistribuidor:btnEncontrarDitribuidor" value="Buscar distribuidores"
                                           showEffect="clip" hideEffect="explode" />
                                <p:overlayPanel widgetVar="overlayDistribuidor" for="btnEncontrarDitribuidor" hideEffect="fade" dynamic="true" style="width: 400px" >
                                    <p:dataTable value="#{comprarMB.listaDistribuidores}" 
                                                 rows="10"
                                                 var="distribuidor"
                                                 scrollable="true"
                                                 selectionMode="single"
                                                 selection="#{comprarMB.distribuidorSeleccionado}"
                                                 rowKey="#{distribuidor.ruc}"
                                                 scrollHeight="300">

                                        <p:ajax event="rowSelect" listener="${comprarMB.filaSeleccionadaDistribuidor}" update=":formDetalleDistribuidor:gridDatosCompra,:formDetalleDistribuidor:txtRuc" />

                                        <p:column headerText="Ruc" filterBy="#{distribuidor.ruc}" >
                                            <p:outputLabel value="#{distribuidor.ruc}" />
                                        </p:column>

                                        <p:column headerText="Nombre" filterBy="#{distribuidor.nombre}" filterFunction="#{filtroMB.filterByName}" >
                                            <p:outputLabel value="#{distribuidor.nombre}"/>
                                        </p:column>

                                    </p:dataTable>

                                </p:overlayPanel>

                            </p:panelGrid>

                        </div>

                        <p:separator/>
                        <!-- Datos del distribuidor para mostrar	 -->
                        <p:panelGrid id="gridDatosCompra" columns="4" style="width: 100%;text-align: left">
                            <b:badge value="Nombre: " />
                            <p:outputLabel  value="#{comprarMB.compra.ruc.nombre}"  />

                            <b:badge value="Direccion: "/>
                            <p:outputLabel value="#{comprarMB.compra.ruc.direccion}"  />

                            <b:badge value="Telefono: " style="background-color: #0087ca;color: white"/>
                            <p:outputLabel value="#{comprarMB.compra.ruc.telefono}"  />

                            <b:badge value="Email: " style="background-color: #0087ca;color: white"/>
                            <p:outputLabel  value="#{comprarMB.compra.ruc.correo}"  />

                        </p:panelGrid>

                        <p:spacer height="15px" />

                        <!-- Panel para mostrar datos de la compra -->
                        <p:panel >
                            <p:panelGrid columns="4">
                                <p:outputLabel value="No Documento: "/>
                                <p:inputText 
                                    placeholder="Numero de Documento"
                                    id="txtNumeroDocumento" 
                                    onkeypress="return noProcesar(event);" 
                                    value="#{comprarMB.compra.codigoDocumento}" />

                                <p:outputLabel value="Fecha Compra:" />
                                <p:calendar   id="txtFechaIngreso" onkeypress="return noProcesar(event);"  pattern="MM/dd/yyyy HH:mm:ss" value="#{comprarMB.compra.fechaIngreso}" title="Fecha cuando se realizo la compra" />

                            </p:panelGrid>

                        </p:panel>

                    </p:panel>
                </h:form>

                <!-- Formulario para controlar el agregar detalle a la compra -->  

                <p:panel header="Agregar Detalles compra" style="text-align: center" styleClass="panelNoBorder titleBarVerdeSuave">
                    <h:form id="formBuscarProducto">
                        <p:panelGrid columns="5" style="margin: 0 auto;height: 100%">

                            <p:outputLabel value="Codigo General:  "/>
                            <p:inputText 
                                placeholder="Codigo del Producto"
                                id="txtCodigoDetalle" 
                                onkeypress="return validarEnter(event, 'btnValidar');" 
                                value="#{comprarMB.codigoDetalle}" />


                            <p:commandButton 
                                styleClass="ui-botonEsmeralda"
                                oncomplete="PF('widgetVarCatalogo').loadContents()" 
                                id="btnEncontrarCatalogo" 
                                icon="ui-icon-search" />

                            <p:tooltip style="font-size: 11px" id="toolTipGrow" for="btnEncontrarCatalogo" value="Buscar Productos"
                                       showEffect="clip" hideEffect="explode" />

                            <p:remoteCommand name="btnValidar" actionListener="#{comprarMB.verificarProducto()}"  update="lblNombreProducto,lblTipoProducto,lblPVP,:formDetalleCompra:panelAgregarProducto,:formBuscarProducto:txtCodigoDetalle"/>

                        </p:panelGrid>

                        <p:separator/>

                        <p:panelGrid columns="9" style="width: 100%">

                            <p:outputLabel value="Nombre:"/>
                            <p:outputLabel id='lblNombreProducto' value="#{comprarMB.catalogo.nombre}" style="font-weight: lighter" />

                            <p:outputLabel value="Tipo:"/>
                            <p:outputLabel id='lblTipoProducto' value="#{comprarMB.catalogo.tipoProducto=='G'?'General':comprarMB.catalogo.tipoProducto=='E'?'Individual':''}" style="font-weight: lighter" />

                            <p:panelGrid columnClasses="2">
                                <p:outputLabel value="PVP:" style="width: 100px"/>
                                <p:commandButton id="btnCambiarPrecio" icon="ui-icon-pencil" actionListener="#{comprarMB.abrirDialogoCambiarPrecio()}" styleClass="ui-botonCeleste" update="@form,:dialogEditPrecio" title="Cambiar el precio del producto" />
                            </p:panelGrid>
                            <p:outputLabel id='lblPVP' value="#{calculosMB.incluirIva(comprarMB.catalogo.precio)}" style="font-weight: lighter" />

                            <p:tooltip style="font-size: 11px" id="toolTipGrow3" for=":formBuscarProducto:btnCambiarPrecio" value="Cambiar el precio de Venta al publico"
                                       showEffect="clip" hideEffect="explode" />

                            <p:outputLabel value="Stock" />
                            <p:outputLabel id="lblStock" value="#{comprarMB.stockProductoSeleccionado}" style="font-weight: lighter" />

                        </p:panelGrid>


                    </h:form>
                </p:panel>

                <p:separator/>

                <!-- Formulario para agregar el detalle de la comprar -->
                <h:form id="formDetalleCompra">
                    <p:panel id="panelAgregarProducto"  style="text-align: center" styleClass="panelNoBorder" visible="#{comprarMB.visibleDetalleAgregar}">

                        <p:panelGrid id="panelGridDetalle" columns="7" style="margin: 0 auto;height: 100%">

                            <p:outputLabel value="Cantidad:"/>
                            <p:inputText required="true" id="txtCantidadDetalle" value="#{comprarMB.cantidadDetalle}" style="width: 50px;" >
                                <p:clientValidator event="keyup"/>
                            </p:inputText>

                            <p:message for="txtCantidadDetalle" display="icon" />

                            <p:outputLabel value="Costo:"/>
                            <p:inputText id="txtCostoDetalle" value="#{comprarMB.costoDetalle}" style="width: 70px;" required="true" />
                            <p:message for="txtCostoDetalle" display="icon" />

                            <p:commandButton id="btnAgregarDetalle" actionListener="#{comprarMB.agregarProducto()}" value="Agregar" update="@form,:formDetalleCompra,:formTotales,:formDetalleCompra:panelGridDetalle" />

                        </p:panelGrid>

                    </p:panel>


                    <!-- Tabla que muestra el detalle de la compra -->
                    <p:dataTable id="tableDetalle" value="#{comprarMB.detalleCompra}" var="detalle">
                        <p:column headerText="Codigo">
                            <h:outputText value="#{detalle.codigo}" />
                        </p:column>

                        <p:column headerText="Nombre">
                            <h:outputText value="#{detalle.nombre}" />
                        </p:column>

                        <p:column headerText="Descripcion">
                            <h:outputText value="#{detalle.descripcion}" />
                        </p:column>

                        <p:column headerText="Precio U.">
                            <h:outputText value="#{detalle.costoIndividual}" />
                        </p:column>


                        <p:column headerText="Cantidad">
                            <h:outputText value="#{detalle.cantidad}" />
                        </p:column>


                        <p:column headerText="Subtotal">
                            <h:outputText value="#{detalle.subtotal}" />
                        </p:column>

                        <p:column headerText="">
                            <p:commandButton value="Eliminar" actionListener="#{comprarMB.eliminarDetalle(detalle)}" update="@form,:formTotales"/>
                        </p:column>

                    </p:dataTable>

                </h:form>

                <!-- Panel para agrupar los totales -->
                <h:form id="formTotales" >
                    <div style="text-align: center;height:140px">
                        <p:panel id="panelTotales" style="width: 250px;float: right"  styleClass="panelNoBorder">
                            <p:panelGrid columns="2" style="text-align: left">
                                <p:outputLabel value="Subtotal: "  />
                                <p:inputText onkeypress="return noProcesar(event);" value="#{comprarMB.sumaTotalCompra}" style="width: 80px;" >
                                    <p:ajax event="blur" listener="#{comprarMB.actualizarValoresTotales()}" update="@form" />
                                </p:inputText>

                                <p:outputLabel value="Descuento: "/>
                                <p:inputText onkeypress="return noProcesar(event);" value="#{comprarMB.compra.descuento}" style="width: 80px;" >
                                    <p:ajax event="blur" listener="#{comprarMB.actualizarValoresTotales()}" update="@form" />
                                </p:inputText>

                                <p:outputLabel value="Iva: "/>
                                <p:inputText onkeypress="return noProcesar(event);" value="#{comprarMB.compra.iva}" style="width: 80px;" >
                                    <p:ajax event="blur" listener="#{comprarMB.actualizarValoresTotales()}" update="@form" />
                                </p:inputText> 

                                <p:outputLabel id="txtTotalCompra" value="Total: "/>
                                <p:inputText onkeypress="return noProcesar(event);" id="total" value="#{comprarMB.compra.total}" style="width: 80px;" />
                            </p:panelGrid>
                        </p:panel>
                    </div>
                </h:form>

                <p:spacer height="5px" />

                <!-- Botones de Accion para la Fatura -->
                <h:form >
                    <p:panel  styleClass="panelNoBorder">
                        <p:panelGrid columns="2" style="margin: 0 auto;width: 20%">                            

                            <p:commandButton 
                                styleClass="ui-botonAzul"
                                process="@this,:formDetalleDistribuidor:txtNumeroDocumento,:formDetalleDistribuidor:txtFechaIngreso"                                              
                                update=":formDetalleDistribuidor:txtNumeroDocumento"
                                value="Comprar" 

                                actionListener="#{comprarMB.ejecutarCompra()}"  >

                            </p:commandButton>
                            <b:commandButton id="nonAjax"  ajax="false" action="compra" value="Cancelar" look="danger"/>                                

                        </p:panelGrid>
                    </p:panel>

                    <!-- Dialogo de confirmacion -->
                    <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
                        <p:commandButton value="Si" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
                        <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
                    </p:confirmDialog>

                    <!-- Dialogo que nueva factura-->
                    <p:dialog header="Nueva Compra" widgetVar="dialogNuevaCompra" modal="true">
                        <h:form>
                            <h2>Desea realizar otra compra?</h2>
                            <p:commandButton  value="Nueva" action="compra" ajax="false"/>
                            <p:commandButton value="Salir" action="compra" ajax="false" />      
                        </h:form>
                    </p:dialog>

                </h:form>

                <!-- Dialogo para agregar el producto especifico-->
                <p:dialog header="Ingreso de producto" widgetVar="dlgProductoGeneral" modal="true" height="100">
                    <h:form id="formAgregarProductoEspecifico">
                        <p:focus id="focus" for="txtCodigoDetalle"/>
                        <p:panel styleClass="panelNoBorder">
                            <p:panelGrid columns="3">
                                <p:outputLabel  value="Ingrese el codigo Especifico:"/>
                                <p:inputText id="txtCodigoDetalle" value="#{comprarMB.codigoEspecificoDetalle}" required="true" requiredMessage="El codigo unico es necesario" />
                                <p:message for="txtCodigoDetalle" display="icon" /> 
                            </p:panelGrid>

                            <p:spacer height="15px" />

                            <div>
                                <p:commandButton value="Aceptar" process="@this,txtCodigoDetalle" actionListener="#{comprarMB.agregarProductoEspecifico()}" update=":formDetalleCompra,txtCodigoDetalle,focus,:formTotales,:formAgregarProductoEspecifico" />
                                <p:commandButton value="Salir" onclick="PF('dlgProductoGeneral').hide();" />
                            </div>
                        </p:panel>
                    </h:form>
                </p:dialog>

                <!-- Dialogo de confirmacion para agregar un nuevo Distribuidor -->
                <p:dialog header="Agregar Distribuidor" widgetVar="confirmarDistribuidor" modal="true">
                    <h:form>
                        <h2>El distribuidor no existe</h2>
                        <p:commandButton onclick="PF('confirmarDistribuidor').hide();" value="Aceptar"/>
                        <p:commandButton actionListener="#{comprarMB.crearNuevoDistribuidor()}"  style="background-image: none;background-color: forestgreen" value="Crear Distribuidor">
                            <p:ajax event="dialogReturn" listener="#{comprarMB.recibirDatos}" update=":formDetalleDistribuidor" />
                        </p:commandButton>                        

                    </h:form>
                </p:dialog>

                <!-- Dialogo que muestra un mensaje de confirmacion para crear un nuevo catalogo del producto -->

                <p:dialog header="Agregar Producto en el Catalogo"  widgetVar="confirmarProducto" modal="true">
                    <h:form>
                        <h2>El Producto no existe en el catologo</h2>
                        <p:commandButton onclick="PF('confirmarProducto').hide();" value="Aceptar"/>
                        <p:commandButton actionListener="#{comprarMB.crearNuevoCatalogo()}"  style="background-image: none;background-color: forestgreen" value="Crear Producto">
                            <p:ajax event="dialogReturn" listener="#{comprarMB.recibirCatalogo}" update=":formBuscarProducto:lblNombreProducto" />
                        </p:commandButton>                        


                    </h:form>
                </p:dialog>

                <!-- Dialogo para cambiar el precio de un catalago -->
                <p:dialog id="dialogEditPrecio" header="Cambiar el precio del producto"  widgetVar="widCambiarPrecio" modal="true">
                    <h:form>
                        <p style="font-weight: bold">Porfavor ingrese el precio del producto:</p>

                        <p:panelGrid columns="2" styleClass="panelNoBorder" style="text-align: left">
                            <p:outputLabel value="Nombre:  " />
                            <p:outputLabel value="#{comprarMB.catalogo.nombre}" style="font-weight: bold" />
                            <p:outputLabel value="Precio:  " />


                            <p:panelGrid columns="2" >
                                <p:inputText id="txtCambiarPrecio" value="#{comprarMB.cambiarCosto}" style="width: 80px;" />
                                <p:selectOneMenu id="cmbIVAPrecio" value="#{comprarMB.ivaCosto}" >

                                    <f:selectItem itemLabel="con Iva" itemValue="+" />                            
                                    <f:selectItem itemLabel="sin Iva " itemValue="-" />                                    
                                </p:selectOneMenu>
                            </p:panelGrid>

                        </p:panelGrid>

                        <p:spacer width="50px"/>


                        <p:commandButton actionListener="#{comprarMB.editarPrecio()}" value="Editar"  style="background-image: none;background-color: forestgreen" update=":formBuscarProducto:lblPVP,:overlayCatalogoID,:formDialgBuscarProductos">
                            <p:confirm header="Confirmar" message="Estas seguro que quieres editar el PVP?" icon="ui-icon-alert" />
                        </p:commandButton>
                        <p:commandButton onclick="PF('widCambiarPrecio').hide();" value="Cancelar" update=":overlayCatalogoID,:formDialgBuscarProductos" />

                    </h:form>
                </p:dialog>

                <!-- Dialogo de confirmacion para grabar -->

                <!-- dialogo para buscar los productos de los catalogos -->
                <p:overlayPanel widgetVar="widgetVarCatalogo" id="overlayCatalogoID" for=":formBuscarProducto:btnEncontrarCatalogo" hideEffect="fade" dynamic="true" style="width:600px">
                    <h:form id="formDialgBuscarProductos">
                        <p:dataTable 
                            rows="10"
                            value="#{comprarMB.listaCatalogos}" 
                            var="catalogo"
                            selectionMode="single" 
                            rowKey="#{catalogo.codigoProducto}"
                            selection="#{comprarMB.catalogoProductoSeleccionado}" >

                            <p:ajax event="rowSelect" listener="#{comprarMB.onRowSelect}" update=":formBuscarProducto:txtCodigoDetalle,:formDetalleCompra:panelAgregarProducto,:formBuscarProducto:lblNombreProducto,:formBuscarProducto:lblTipoProducto,:formBuscarProducto:lblPVP,:formBuscarProducto:lblStock"/>
                            <!--<p:ajax event="rowUnselect" listener="#{comprarMB.onRowUnSelect}"/>-->

                            <p:column headerText="codigo" filterBy="#{catalogo.codigoProducto}"  filterFunction="#{filtroMB.filterByName}"  filterMatchMode="contains" >
                                <p:outputLabel value="#{catalogo.codigoProducto}"/>
                            </p:column>

                            <p:column filterBy="#{catalogo.nombre}"  filterFunction="#{filtroMB.filterByName}"  filterMatchMode="contains" headerText="nombre">
                                <p:outputLabel value="#{catalogo.nombre}"/>
                            </p:column>

                            <p:column headerText="descripcion">
                                <p:outputLabel value="#{catalogo.descripcion}"/>
                            </p:column>

                            <p:column headerText="marca">
                                <p:outputLabel value="#{catalogo.marca}"/>
                            </p:column>

                            <p:column headerText="precio">
                                <p:outputLabel value="#{catalogo.precio}"/>
                            </p:column>                                    

                        </p:dataTable>
                    </h:form>
                </p:overlayPanel>

            </p:panel>  


        </div>



    </ui:define>
</ui:composition>
